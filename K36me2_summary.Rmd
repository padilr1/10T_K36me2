---
title: ""
author: ""
date: ""
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 3
    smooth_scroll: false
    theme: cerulean
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(tidyverse)
library(rtracklayer)
library(pals)
library(highcharter)
library(plotly)
library(heatmaply)
library(plotlyutils)
library(plotly)
library(htmltools)
library(uwot)
library(smacof)
library(trelliscopejs)
library(LOLA)
library(upsetjs)
library(jsonlite)
library(limma)
library(crosstalk)
library(DT)
library(future)
library(knitr)
library(png)
#plan(multisession(workers = 16))
library(furrr)
library(future.apply)
library(ggrepel)
setwd("~/Documents/10T_K36me2")
#
library(ChIPseeker)
library(TxDb.Mmusculus.UCSC.mm10.knownGene)
library(org.Mm.eg.db)
txdb <- TxDb.Mmusculus.UCSC.mm10.knownGene
options(ChIPseeker.ignore_1st_exon = TRUE)
options(ChIPseeker.ignore_1st_intron = TRUE)
options(ChIPseeker.ignore_downstream = TRUE)
options(ChIPseeker.ignore_promoter_subcategory = TRUE)
```

```{r echo = FALSE, warning=FALSE,message=FALSE,out.width='100%'}
setwd("~/Documents/10T_K36me2")
wd <- paste0("~~/Documents/10T_K36me2")
```

# Mass-spec

## K36 & K27
```{r,echo = FALSE,fig.show = "hold", out.width = "100%", fig.align = "default"}
include_graphics(path = "~/Documents/10T_K36me2/images/10T.ms.graph.png",dpi = 600)
```

## K27 ratio
```{r,echo = FALSE,fig.show = "hold", out.width = "100%", fig.align = "default"}
include_graphics(path = "~/Documents/10T_K36me2/images/10T.ms.graph.K27ratio.png",dpi = 600)
```

## K4 & K9
```{r,echo = FALSE,fig.show = "hold", out.width = "100%", fig.align = "default"}
include_graphics(path = "~/Documents/10T_K36me2/images/10T.ms.graph.K4me.K9me.png",dpi = 600)
```

# K36me2 10kb bins

```{r include=FALSE}
rx <- fread("~/Documents/10T_K36me2/data/rx/rx.final.csv")

md <- rx[,1:3] %>% column_to_rownames('samp')

codr <- c("PA","QKO","TKO","SETD2KO","K36M","NSD12DKO","NSD3KO","NSD3")
```


## PCA

We can use the log2 enrichment over input matrix as input to PCA (after scaling/centering)
```{r,echo = FALSE,fig.show = "hold", out.width = "100%", fig.align = "default"}
load("~/Documents/10T_K36me2/data/RData/clustering/PCA.RData")
pd %>%
  ggplot(aes(x = `PC1 (43%)`, y = `PC2 (22%)`, color = cond)) +
  geom_point(size = 3, show.legend = T) +
  geom_text_repel(aes(label=samp),show.legend = FALSE) +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0) +
  xlab(label = "PC1 (43%)") +
  ylab(labe = "PC2 (22%)")
```

## Correlation {.tabset}

We can also take the same log2 enrichment matrix and check the correlation among samples

### Pearson
```{r, out.height='900px', echo = FALSE, warning=FALSE,message=FALSE}
load(file="~/Documents/10T_K36me2/data/RData/clustering/lfc.RData")
cm <- cor(lfc_final, method = 'pearson')
hm <- heatmaply_cor(cm, 
                row_side_colors = md[rownames(cm),],
                col_side_colors = md[colnames(cm),])

hm$x$layout$annotations <- lapply(hm$x$layout$annotations, function(x) {
  x$text <- ''
})

hm %>%
  layout(height = 500)
```

### Spearman

```{r, out.height='900px',echo = FALSE, warning=FALSE,message=FALSE}
cm <- cor(lfc_final, method = 'spearman')
hm <- heatmaply_cor(cm, 
                row_side_colors = md[rownames(cm),],
                col_side_colors = md[colnames(cm),])

hm$x$layout$annotations <- lapply(hm$x$layout$annotations, function(x) {
  x$text <- ''
})

hm %>%
  layout(height = 500)
```

# Peaks 

We can also call enriched regions using [SICER](https://academic.oup.com/bioinformatics/article/25/15/1952/212783) as implemented in [epic2](https://academic.oup.com/bioinformatics/article/35/21/4392/5421513)

## Annotation

Peaks that are 10kb adjacent to another peak were merged within a sample. The intersect of replicates were then taken. 

```{r,echo = FALSE,fig.show = "hold", out.width = "100%", fig.align = "default"}
# s <- list.files(path = "data/epic2.peaks.final", pattern = '.epic2.',full.names = FALSE,recursive = FALSE) %>%
#   tibble(f = .) %>%
#   separate(f,c("samp",NA,NA,NA),'\\.',F) %>%
#   mutate(f = file.path('data/epic2.peaks.final', f))
# d <- deframe(s[,c('samp', 'f')])
# peak_annot <- lapply(d,annotatePeak,TxDb = txdb,tssRegion = c(-3000, 3000))
load(file="~/Documents/10T_K36me2/data/RData/annotation/all_samples_annotation.RData")
# peak_annot_final <- peak_annot[c("PA","NSD3_unedit","NSD3KO","SETD2KO","K36M","NSD12DKO","TKO","QKO")]
plotAnnoBar(peak_annot_final)
```



